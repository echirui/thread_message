# Feature Specification: LINE風スレッドチャットとGitHub課題連携

**Feature Branch**: `001-threaded-issue-chat`
**Created**: 2025-12-01
**Status**: Draft
**Input**: User description: "line 風メッセージアプリを作成したいです。メッセージからthreadをネストさせてやりとりできるようにしたいです。また、github のissue と紐づけられるようにしたいです。気軽にディスカッションしてissueを作成できるようにしたいです。ドキュメントは全て日本語で書いてください。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - リアルタイムメッセージの送受信 (Priority: P1)

チームメンバーとして、LINEのようなインターフェースでリアルタイムにメッセージを交換したい。これにより、チーム内のコミュニケーションを円滑に行うことができる。

**Why this priority**: メッセージングアプリとしての基本機能であり、これがなければアプリとして成立しないため。

**Independent Test**: 2つの異なるクライアント（ユーザー）を用意し、片方でメッセージを送信した際、もう片方で即座に受信・表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** メインのチャット画面を開いているとき、 **When** テキストメッセージを入力して送信ボタンを押すと、 **Then** 自分の画面に即座にメッセージが表示され、他のユーザーの画面にも表示される。
2. **Given** 他のユーザーからメッセージを受信したとき、 **When** そのメッセージが表示される際、 **Then** 画面の左側（または相手を区別できるスタイル）にアバターや名前と共に表示される。
3. **Given** 自分がメッセージを送信したとき、 **When** そのメッセージが表示される際、 **Then** 画面の右側（または自分を区別できるスタイル）に表示される。

---

### User Story 2 - スレッドによる詳細な議論 (Priority: P1)

ユーザーとして、特定のメッセージに対してネストされたスレッドで返信したい。これにより、メインのチャットフローを乱すことなく、特定のトピックについて詳細な議論を行うことができる。

**Why this priority**: 「メッセージからthreadをネストさせてやりとりできる」という主要な要望を満たすため。

**Independent Test**: メインチャンネルのメッセージに対して返信を行い、メインチャンネルには新しいメッセージとして表示されず、スレッドビュー内のみに表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** メインチャンネルにメッセージがあるとき、 **When** 「返信」または「スレッドを開始」ボタンを押すと、 **Then** 専用のスレッドビュー（サイドパネルやオーバーレイ）が開く。
2. **Given** スレッドが開いているとき、 **When** メッセージを送信すると、 **Then** そのメッセージはスレッド内のみに表示され、メインチャンネルの最下部には流れない。
3. **Given** 返信がついているメッセージがメインチャンネルにあるとき、 **When** そのメッセージを見ると、 **Then** 返信数などのインジケーター（例：「3件の返信」）が表示される。

---

### User Story 3 - GitHubアカウント連携 (Priority: P2)

ユーザーとして、GitHubアカウントを使用して認証を行いたい。これにより、アプリが自分の代わりにリポジトリ情報にアクセスしたり、Issueを作成したりできるようになる。

**Why this priority**: GitHub Issueとの紐付け機能の前提条件となるため。

**Independent Test**: 「GitHubでログイン」を行い、連携後にユーザープロフィールがGitHub情報と紐付いていることを確認する。

**Acceptance Scenarios**:

1. **Given** 未認証のユーザーであるとき、 **When** GitHub連携機能を使用しようとすると、 **Then** GitHubのOAuth認証画面にリダイレクトされる。
2. **Given** OAuth認証を完了したとき、 **When** アプリに戻ると、 **Then** 自分のGitHubユーザー名がアプリ内で認識され、連携状態となる。

---

### User Story 4 - スレッドからGitHub Issueを作成 (Priority: P2)

ユーザーとして、議論が行われているスレッドから直接GitHub Issueを簡単に作成したい。これにより、会話の中で発生したタスクやバグ報告をスムーズにプロジェクト管理ツールに移行できる。

**Why this priority**: 「気軽にディスカッションしてissueを作成できる」という主要な価値提案を実現するため。

**Independent Test**: スレッド内の「Issue作成」アクションを実行し、実際にGitHubリポジトリに新しいIssueが作成されることを確認する。

**Acceptance Scenarios**:

1. **Given** スレッドで議論中であるとき、 **When** 「Issueを作成」ボタンを押すと、 **Then** スレッドの内容（要約や選択したメッセージ）が自動入力された作成フォームが表示される。
2. **Given** Issue作成フォームでリポジトリを選択し送信すると、 **When** 作成が成功した際、 **Then** スレッド内に「Issue #123 を作成しました」というシステムメッセージとリンクが表示される。
3. **Given** Issue作成時、 **When** 対象のリポジトリを選択する際、 **Then** 自分がアクセス権を持つリポジトリの一覧から選択できる。

---

### User Story 5 - 既存のGitHub Issueとの紐付け (Priority: P3)

ユーザーとして、既存のGitHub IssueのURLを貼り付けることで紐付けを行いたい。これにより、チャット内で外部のタスク状況を参照できるようになる。

**Why this priority**: 必須の作成機能に次いで、既存情報の参照も重要であるため。

**Independent Test**: チャットにGitHub IssueのURLを貼り付け、リンクプレビュー（タイトルやステータス）が正しく表示されるか確認する。

**Acceptance Scenarios**:

1. **Given** チャットまたはスレッド入力欄に、 **When** GitHub IssueのURLを貼り付けて送信すると、 **Then** アプリがそれを検知し、Issueのタイトル、ステータス、担当者などの情報をカード形式などで展開表示する。

### Edge Cases

- ユーザーのGitHubアクセストークンが期限切れになった場合、再認証を促すか。
- GitHub APIのレート制限に達した場合、適切なエラーメッセージを表示するか。
- 紐付けられたIssueがGitHub側で削除された場合、リンクはどう表示されるか（「Not Found」等の表示）。
- 親メッセージが削除された場合、そのスレッド内のメッセージはどうなるか（アーカイブされるか、親なしで残るか）。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、ユーザーが共有チャンネル内でテキストメッセージを送受信できるようにしなければならない。
- **FR-002**: システムは、任意のメッセージに対して1階層のネスト（スレッド）を作成できるようにしなければならない。
- **FR-003**: システムは、メッセージを「LINE風」のインターフェース（自分の投稿は右、他人は左）で表示しなければならない。
- **FR-004**: システムは、GitHub OAuth 2.0を利用してユーザー認証を行わなければならない。
- **FR-005**: システムは、ユーザーがアクセス可能なGitHubリポジトリ一覧を取得し、選択できるようにしなければならない。
- **FR-006**: システムは、スレッドやメッセージの内容を利用して新しいGitHub Issueを作成できなければならない。
- **FR-007**: システムは、Issue作成成功時に、そのIssueへのリンクを含む確認メッセージを自動投稿しなければならない。
- **FR-008**: システムは、チャット内に貼り付けられたGitHub IssueのURLを展開し、主要情報（タイトル、ステータス等）を表示しなければならない。

### Key Entities *(include if feature involves data)*

- **User**: アプリユーザー。GitHubユーザーIDと紐付く。
- **Message**: テキスト内容、送信日時、送信者、親メッセージID（スレッド返信の場合）を持つ。
- **Thread**: 親メッセージと、それに紐付く子メッセージの集合によって定義される仮想的な単位。
- **GitHub Integration**: OAuthトークンやユーザーのリポジトリ設定を管理する。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーがメッセージを送信してから、他のクライアントに表示されるまでの遅延が1秒以内であること（リアルタイム性）。
- **SC-002**: ユーザーが「Issue作成」を開始してから、送信を完了するまでの操作が30秒以内に完結できること（UIの効率性）。
- **SC-003**: アプリから作成されたIssueの100%に、元のチャットスレッドへのバックリンクや参照が含まれていること（コンテキストの維持）。
- **SC-004**: GitHub APIのレート制限エラー発生時に、アプリがクラッシュせず、ユーザーに「後で再試行してください」等の適切なメッセージを表示できること。